<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rich Text Editor</title>
  </head>
  <body>
    <!-- script placeholder -->
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      .editor-container,
      .ck-editor,
      .ck-editor__editable {
        height: 100% !important;
      }
      .ck-editor__main {
        height: calc(100% - 43px) !important;
      }
    </style>
    <div class="editor-container">
      <div class="editor">
        <!-- content placeholder -->
      </div>
    </div>
    <script>
      (() => {
        let editor;
        let updatingContent = false;
        const watchdog = new CKSource.EditorWatchdog();
        window.watchdog = watchdog;
        watchdog.setCreator((element, config) => {
          return CKSource.Editor.create(element, config).then((ed) => {
            editor = ed;
            editor.model.document.on('change:data', () => {
              if (updatingContent) {
                updatingContent = false;
                return; // prevent infinite loop
              }
              updateCode();
            });
            return editor;
          });
        });
        watchdog.setDestructor((editor) => {
          return editor.destroy();
        });
        watchdog.on('error', handleError);
        watchdog.create(document.querySelector('.editor'), { licenseKey: '' }).catch(handleError);

        function handleError(error) {
          console.error('Oops, something went wrong!');
          console.error(
            'Please, report the following error on https://github.com/ckeditor/ckeditor5/issues with the build id and the error stack trace:',
          );
          console.warn('Build id: 7sksrqy1264q-72qyzxrbufd5');
          console.error(error);
        }
        function updateCode() {
          parent.postMessage(
            { type: 'ckeditorCode', payload: { html: editor?.getData() || '' } },
            '*',
          );
        }

        window.addEventListener('message', function (event) {
          if (event.data.html) {
            updatingContent = true;
            editor.setData(event.data.html);
          } else if (event.data.type === 'updateCode') {
            updateCode();
          } else if (event.data.type === 'setTheme') {
          }
        });
        document.addEventListener('keydown', function (ev) {
          if (ev.ctrlKey && ev.key === 's') {
            // save
          }
        });

        window.addEventListener('load', () => {
          parent.postMessage({ type: 'ckeditorLoaded', payload: true }, '*');
          updateCode();
        });
      })();
    </script>
  </body>
</html>
